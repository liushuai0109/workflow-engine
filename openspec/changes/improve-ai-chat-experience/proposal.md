# Proposal: 改进 AI 聊天体验

## 概述

全面优化 AI 聊天界面的用户体验，包括 UI 组件库优化、消息流转逻辑修复、加载状态改进和样式布局优化。

## 动机

当前 AI 聊天功能存在以下问题：

1. **UI 不一致**：TDesign 迁移到 Ant Design 后，部分组件样式未统一
2. **交互问题**：
   - Enter 键无法发送消息
   - 输入内容后发送按钮仍然 disabled
   - Tab 图标和文字间距过大
3. **消息混乱**：工具调用的中间结果被错误保存为用户消息
4. **缺少反馈**：AI 处理时没有明确的加载状态
5. **滚动问题**：新消息不会自动滚动到底部，切换 Tab 也不会滚动
6. **响应冗长**：AI 画完流程图后输出大量冗余说明
7. **布局问题**：BPMN 编辑器高度无法正确填充
8. **缺少过程反馈**：AI 执行工具时，用户看不到详细的操作过程
9. **响应格式单一**：AI 回复为纯文本，不支持 Markdown 格式化

## 目标

1. **统一 UI 风格**：所有 AI 聊天相关组件采用 Ant Design 设计规范
2. **修复交互**：确保输入、发送、滚动等基础功能正常工作
3. **优化消息流**：只保存用户消息和 AI 最终响应，不保存中间工具调用
4. **改善反馈**：添加明确的加载状态指示
5. **简化响应**：AI 完成操作后简短确认即可
6. **增强过程可见性**：实时显示 AI 执行的每个操作步骤
7. **支持富文本响应**：使用 Markdown 渲染最终响应，支持列表、代码、链接等格式

## 范围

### 包含
- AI 聊天界面组件（ChatBox）
- 右侧面板容器（RightPanelContainer）
- BPMN 编辑器页面（BpmnEditorPage）
- Claude LLM 服务（消息保存逻辑）
- 系统提示词（响应格式要求）
- 相关样式和布局
- 消息增量更新机制
- Markdown 渲染集成（markdown-it）
- editorOperationService 事件监听

### 不包含
- 后端 API 修改
- 数据库 schema 变更
- LLM 模型配置
- 其他编辑器功能

## 利益相关者

- **最终用户**：更流畅的 AI 聊天体验
- **开发团队**：更清晰的代码结构和组件通信

## 依赖

- 已完成 `integrate-antd-framework` 变更（Ant Design 基础集成）
- Vue 3 Composition API
- Ant Design Vue 4.2.6
- markdown-it ^14.0.0（Markdown 解析器）

## 风险与缓解

### 风险
1. **消息历史丢失**：修改消息保存逻辑可能影响现有聊天记录
2. **组件通信复杂**：父子组件间的消息传递可能出错

### 缓解措施
1. 只修改新消息的保存逻辑，不影响历史记录加载
2. 使用 Vue 标准的 `ref` 和 `defineExpose` 机制，避免 DOM 查询
3. 添加详细的日志和错误处理

## 成功标准

- [ ] Enter 键可以正常发送消息
- [ ] 输入内容后发送按钮自动启用
- [ ] AI 处理时显示加载指示器（聊天框和画布）
- [ ] 新消息自动滚动到底部
- [ ] 切换到聊天 Tab 自动滚动到底部
- [ ] 聊天记录只包含用户消息和 AI 最终响应
- [ ] AI 完成操作后回复简短（如"已完成"）
- [ ] BPMN 编辑器正确填充容器高度
- [ ] Tab 图标和文字间距为 5px
- [ ] 所有样式符合 Ant Design 设计规范
- [ ] AI 执行工具时，聊天框增量显示操作过程（如"✅ 创建连线..."）
- [ ] 所有操作完成后，用 Markdown 格式的摘要替换过程消息
- [ ] Markdown 消息正确渲染（支持标题、列表、代码块、链接等）
- [ ] 过程消息使用合适的样式（不同于最终消息）

## 实施计划

详见 `tasks.md`

## 替代方案

### 方案 1：保留完整对话历史
将工具调用也保存到数据库，但添加 `hidden` 标记不显示

**优点**：完整的对话追溯
**缺点**：数据库存储增加，UI 需要复杂的过滤逻辑

**决策**：不采用，用户只关心最终结果

### 方案 2：使用事件总线通信
用 EventBus 替代 ref 进行组件通信

**优点**：解耦更好
**缺点**：调试困难，难以追踪消息流

**决策**：不采用，Vue ref 机制已足够清晰

## 未来考虑

- 消息编辑和重新生成
- 聊天历史搜索
- 导出聊天记录
- 多轮对话上下文优化
