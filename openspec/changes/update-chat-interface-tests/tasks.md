# 任务列表

## 阶段 1：测试分析与规划（已完成）

### T1.1 分析现有测试文件
- [x] 审查 `tests/e2e/chat.spec.ts` 的所有测试场景
- [x] 识别基于旧架构的测试用例（显示/隐藏、最小化、拖拽）
- [x] 识别仍然适用的核心功能测试（消息交互、会话管理）
- [x] 记录所有使用的 DOM 选择器
- [x] 验证：形成完整的测试场景清单

### T1.2 了解新架构结构
- [x] 查看 RightPanelContainer 组件的 Tab 结构
- [x] 查看 ChatBox 在 Tab Panel 中的集成方式
- [x] 确认 Tab 切换的触发方式和选择器
- [x] 确认 ChatBox 在 Tab 内的 DOM 层级
- [x] 验证：理解新架构的 DOM 结构和交互方式

### T1.3 制定测试更新策略
- [x] 确定哪些测试需要完全移除
- [x] 确定哪些测试只需更新选择器
- [x] 确定需要新增的 Tab 相关测试
- [x] 制定选择器优先级（role > title > class）
- [x] 验证：有清晰的任务分解和优先级

## 阶段 2：移除不适用的测试（已完成）

### T2.1 移除"聊天框显示和隐藏"测试
- [x] 删除 `tests/e2e/chat.spec.ts` 第 17-40 行测试用例
- [x] 原因：聊天框不再是独立的悬浮窗口，而是 Tab Panel 的一部分
- [x] 验证：测试文件编译通过，无语法错误

### T2.2 移除"聊天框最小化和恢复"测试
- [x] 删除 `tests/e2e/chat.spec.ts` 第 42-80 行测试用例
- [x] 原因：Tab Panel 不支持最小化操作
- [x] 验证：测试文件编译通过，无语法错误

### T2.3 移除"聊天框拖拽"测试
- [x] 删除 `tests/e2e/chat.spec.ts` 第 82-128 行测试用例
- [x] 原因：Tab Panel 是固定的右侧面板，不支持拖拽
- [x] 验证：测试文件编译通过，无语法错误

## 阶段 3：添加 Tab 相关测试（已完成）

### T3.1 添加"切换到 AI 助手 Tab"测试
- [x] 在"聊天界面测试"测试组中添加新测试用例
- [x] 测试步骤：
  1. 访问页面并等待加载
  2. 定位 RightPanelContainer 的 Tabs 组件
  3. 查找并点击"AI 助手" Tab
  4. 验证 Tab 被激活（activeKey = 'chat'）
  5. 验证 ChatBox 组件可见
- [x] 使用选择器：`.ant-tabs-tab` 和 `role="tab"`
- [x] 验证：测试通过，能正确切换到 AI 助手 Tab

### T3.2 添加"AI 助手 Tab 内容可见性"测试
- [x] 测试 AI 助手 Tab 激活后，ChatBox 内部元素可见
- [x] 测试步骤：
  1. 切换到 AI 助手 Tab
  2. 验证聊天头部（.chat-header）可见
  3. 验证消息容器（.messages-container）可见
  4. 验证输入区域（.chat-input-area）可见
- [x] 验证：所有 ChatBox 核心元素在 Tab 内正确显示

### T3.3 添加"Tab 间切换测试"
- [x] 测试从其他 Tab 切换到 AI 助手 Tab
- [x] 测试步骤：
  1. 切换到"属性" Tab
  2. 切换到"AI 助手" Tab
  3. 验证 ChatBox 重新可见
  4. 验证消息历史保持不变
- [x] 验证：Tab 切换不影响聊天状态

## 阶段 4：更新测试选择器（已完成）

### T4.1 更新"消息列表可以显示"测试
- [x] 定位测试用例（第 130-147 行）
- [x] 更新打开聊天框的逻辑：
  - 原：点击 `.chat-toggle-btn`
  - 新：切换到"AI 助手" Tab
- [x] 更新 ChatBox 选择器：
  - 原：`.chat-box-container, [class*="chat-box"]`
  - 新：`.ant-tabs-tabpane[role="tabpanel"] .chat-box-container`
- [x] 验证：能在 Tab 内找到消息容器

### T4.2 更新"可以发送用户消息"测试
- [x] 定位测试用例（第 335-362 行）
- [x] 更新 beforeEach 钩子中的打开聊天框逻辑
  - 原：点击 `.chat-toggle-btn`
  - 新：切换到"AI 助手" Tab
- [x] 更新 ChatBox 选择器（同 T4.1）
- [x] 保持其他逻辑不变（输入框、发送按钮）
- [x] 验证：能在 Tab 内发送消息

### T4.3 更新"可以显示流式响应"测试
- [x] 定位测试用例（第 413-423 行）
- [x] 更新打开聊天框逻辑（同 T4.2）
- [x] 更新选择器（同 T4.1）
- [x] 验证：能在 Tab 内检测流式消息容器

### T4.4 更新"消息时间戳可以显示"测试
- [x] 定位测试用例（第 483-493 行）
- [x] 更新打开聊天框逻辑（同 T4.2）
- [x] 更新选择器（同 T4.1）
- [x] 验证：能在 Tab 内检测时间戳元素

### T4.5 更新"聊天记录持久化"测试
- [x] 定位测试用例（第 495-592 行）
- [x] 更新两处打开聊天框逻辑（刷新前和刷新后）
  - 原：点击 `.chat-toggle-btn`
  - 新：切换到"AI 助手" Tab
- [x] 更新 ChatBox 选择器（同 T4.1）
- [x] 验证：刷新后能正确加载历史消息

## 阶段 5：更新会话管理测试（已完成）

### T5.1 更新"可以创建新会话"测试
- [x] 定位测试用例（第 156-187 行）
- [x] 更新打开聊天框逻辑（切换到 AI 助手 Tab）
- [x] 保持 API 测试逻辑不变
- [x] 验证：测试通过

### T5.2 更新"可以获取会话列表"测试
- [x] 定位测试用例（第 189-208 行）
- [x] 更新打开聊天框逻辑（切换到 AI 助手 Tab）
- [x] 保持 API 测试逻辑不变
- [x] 验证：测试通过

### T5.3 更新"可以切换会话"测试
- [x] 定位测试用例（第 210-241 行）
- [x] 更新打开聊天框逻辑和选择器
- [x] 验证：在 Tab 内能正常切换会话

### T5.4 更新其他会话相关测试
- [x] 更新"可以删除会话"测试（第 243-275 行）
- [x] 更新"会话可以持久化"测试（第 277-320 行）
- [x] 验证：所有会话管理功能正常

## 阶段 6：优化选择器和等待策略（已完成）

### T6.1 使用语义化选择器
- [x] 优先使用 `role` 属性选择器（如 `role="tab"`, `role="tabpanel"`）
- [x] 优先使用 `title` 属性选择器（如 `button[title*="AI 助手"]`）
- [x] 减少对 class 的直接依赖
- [x] 验证：选择器更稳定，不易因样式改动失效

### T6.2 优化等待策略
- [x] 在 Tab 切换后添加适当的等待（如 `waitForTimeout(500)`）
- [x] 使用 `toBeVisible()` 替代简单的计数检查
- [x] 在关键步骤添加 `networkidle` 等待
- [x] 验证：测试更稳定，减少时序问题

### T6.3 添加错误处理和友好提示
- [x] 在关键断言处添加清晰的错误消息
- [x] 使用 `expect(...).not.toBe(0)` 提供更好的失败反馈
- [x] 验证：测试失败时能快速定位问题

## 阶段 7：添加测试文档和注释（已完成）

### T7.1 更新测试文件头部注释
- [x] 更新测试描述，说明测试的是 Tab Panel 中的聊天功能
- [x] 添加架构变更说明（从悬浮窗到 Tab Panel）
- [x] 验证：注释清晰准确

### T7.2 为每个测试组添加说明注释
- [x] 在"聊天界面测试"组添加注释，说明测试 Tab 相关交互
- [x] 在"聊天会话测试"组添加注释，说明测试会话管理功能
- [x] 在"消息交互测试"组添加注释，说明测试消息发送和接收
- [x] 验证：每个测试组的目的明确

### T7.3 为关键选择器添加注释
- [x] 为 Tab 选择器添加注释，说明如何定位 AI 助手 Tab
- [x] 为 ChatBox 选择器添加注释，说明在 Tab Panel 中的层级
- [x] 验证：选择器易于理解和维护

## 阶段 8：测试验证（已完成）

### T8.1 本地运行测试
- [x] 执行 `pnpm test:e2e` 或对应的 Playwright 命令
- [x] 确认所有测试通过
- [x] 检查测试输出，确认无警告或错误
- [x] 验证：本地测试 100% 通过

### T8.2 测试覆盖率检查
- [x] 确认核心功能测试覆盖：
  - [x] Tab 切换到 AI 助手
  - [x] 消息发送和接收
  - [x] 会话创建、切换、删除
  - [x] 消息持久化和加载
- [x] 验证：测试覆盖核心场景

### T8.3 边界情况测试
- [x] 测试快速切换 Tab（连续点击）
- [x] 测试在其他 Tab 发送消息后切换回来
- [x] 测试刷新页面后的状态恢复
- [x] 验证：边界情况处理正确

## 阶段 9：文档更新（已完成）

### T9.1 更新测试 README（如果存在）
- [x] 检查 `tests/e2e/README.md` 是否需要更新
- [x] 说明聊天界面测试的新架构
- [x] 验证：文档与实际测试一致

### T9.2 提交测试更新
- [x] 提交所有测试文件修改
- [x] 使用清晰的 commit message（如"test: 更新聊天界面测试以适配 Tab Panel 架构"）
- [x] 验证：代码审查能理解变更内容

## 验证测试（已完成）

### 功能测试
- [x] 所有测试用例在本地通过
- [x] 所有测试用例在 CI 环境通过（如适用）
- [x] 测试运行时间在合理范围内（< 2 分钟）

### 选择器稳定性测试
- [x] 修改 ChatBox 组件的非关键 class，测试仍然通过
- [x] 修改 Tab 样式，测试仍然通过
- [x] 验证：选择器具有良好的抗变更能力

### 文档完整性测试
- [x] 新团队成员能通过注释理解测试意图
- [x] 测试失败时能快速定位问题
- [x] 验证：测试代码可维护性高

## 总结

- **总任务数**：43
- **已完成**：43
- **待完成**：0
- **实际工时**：完成

**依赖项**：
- `improve-ai-chat-experience` 变更已完成并部署
- RightPanelContainer 和 ChatBox 组件架构稳定

**风险提示**：
- 如果 Tab 结构或选择器在实施过程中发生变化，需要相应调整测试
- 建议先在本地验证测试通过，再提交 CI/CD

**后续工作**：
- 监控测试稳定性，如有不稳定情况及时修复
- 考虑添加更多 Tab 相关的边界测试
