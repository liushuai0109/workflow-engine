# Proposal: 更新聊天界面相关测试用例

## 概述

更新聊天界面相关的 E2E 测试用例，以适配聊天窗口架构从独立悬浮对话框变更为右侧面板中的 Tab Panel 的新设计。

## 动机

在前期的 `improve-ai-chat-experience` 变更中，聊天界面经历了重大架构调整：
- **原架构**：ChatBox 是一个独立的悬浮对话框，通过触发按钮显示/隐藏，支持拖拽、最小化等窗口操作
- **新架构**：ChatBox 已集成到 RightPanelContainer 的 Tab Panel 中，作为"AI 助手" Tab 存在，与属性面板、Mock、Debug、拦截器等面板并列

当前 E2E 测试文件 `tests/e2e/chat.spec.ts` 仍然基于旧架构编写，包含以下不再适用的测试场景：
1. **显示/隐藏测试**：测试聊天框的打开和关闭按钮 (行 17-40)
2. **最小化/恢复测试**：测试聊天框的窗口最小化功能 (行 42-80)
3. **拖拽测试**：测试聊天框的窗口拖拽功能 (行 82-128)

这些测试场景与新的 Tab Panel 架构不符，需要更新为：
- Tab 切换测试（验证能切换到 AI 助手 Tab）
- Tab 内容可见性测试
- 其他与新架构相关的交互测试

## 目标

1. **更新测试选择器**：修改所有基于旧架构的 DOM 选择器，使其适配 Tab Panel 结构
2. **替换不适用测试**：移除窗口相关测试（显示/隐藏、最小化、拖拽），添加 Tab 切换相关测试
3. **保留核心功能测试**：保持消息交互、会话管理、持久化等核心功能的测试覆盖
4. **提高测试稳定性**：优化选择器和等待策略，减少测试不稳定性

## 范围

### 包含
- E2E 测试文件 `tests/e2e/chat.spec.ts`
- 测试选择器更新（适配 RightPanelContainer 和 Tab 结构）
- 测试场景更新（移除窗口操作，添加 Tab 交互）
- 测试文档更新（如有）

### 不包含
- 其他 E2E 测试文件的修改
- 单元测试的修改
- ChatBox 组件本身的功能修改
- RightPanelContainer 组件的修改

## 利益相关者

- **QA 团队**：获得准确反映当前架构的测试用例
- **开发团队**：通过 CI/CD 获得可靠的测试反馈
- **维护人员**：更易理解和维护的测试代码

## 依赖

- 已完成 `improve-ai-chat-experience` 变更（聊天界面架构调整）
- Playwright 测试框架
- RightPanelContainer 组件的 Tab 结构稳定

## 风险与缓解

### 风险
1. **测试覆盖不足**：移除旧测试后，可能遗漏某些边界情况
2. **选择器不稳定**：新选择器可能因组件更新而失效

### 缓解措施
1. 确保核心功能（消息发送、会话管理、持久化）的测试覆盖不降低
2. 使用语义化选择器（role、title）优先，减少对 class 的依赖
3. 添加详细注释说明测试意图

## 成功标准

- [x] 所有聊天相关测试用例通过 Playwright 执行
- [x] 测试选择器准确反映新的 Tab Panel 架构
- [x] 移除所有不适用的窗口操作测试（显示/隐藏、最小化、拖拽）
- [x] 添加 Tab 切换和可见性测试
- [x] 核心功能测试（消息交互、会话管理、持久化）保持完整
- [x] 测试代码注释清晰，易于理解和维护

## 实施计划

详见 `tasks.md`

## 替代方案

### 方案 1：保留旧测试，添加新测试
保留所有旧测试用例，同时添加新的 Tab 相关测试

**优点**：测试覆盖更全面
**缺点**：
- 旧测试必定失败，造成 CI/CD 噪音
- 维护成本高，容易混淆

**决策**：不采用，旧测试已不适用当前架构

### 方案 2：完全重写测试文件
从头开始重写整个测试文件

**优点**：可以采用全新的测试结构
**缺点**：
- 工作量大
- 可能遗漏已有的测试覆盖

**决策**：不采用，增量更新即可满足需求

## 未来考虑

- 添加更多 Tab 交互场景测试（如 Tab 间状态保持）
- 考虑添加可视化回归测试（Visual Regression Testing）
- 优化测试性能（并行化、减少等待时间）
