# 设计文档：工作流执行回滚逻辑

## 上下文

工作流执行引擎需要支持从任意节点开始执行，但必须处理以下场景：
1. 从非当前节点执行时，需要回滚到该节点
2. 某些节点类型（边界事件、中间捕获事件）有特殊的回滚规则
3. 执行完节点后需要自动流转，但某些节点类型需要暂停

## 目标 / 非目标

### 目标
- 实现完整的回滚判断逻辑，支持边界事件、中间捕获事件、普通节点
- 实现 can_fallback 检查机制
- 实现自动流转排除机制（UserTask、IntermediateCatchEvent、EventBasedGateway）
- 实现跳步骤异常处理

### 非目标
- 不实现实际的回滚操作（回滚操作由外部系统处理）
- 不实现节点状态持久化（由现有机制处理）
- 不实现复杂的并发控制（由现有机制处理）

## 决策

### 决策 1：回滚判断时机
**决策**：在执行节点前进行回滚判断
**理由**：确保执行前状态正确，避免执行后才发现需要回滚

### 决策 2：回滚判断逻辑分离
**决策**：根据节点类型分别实现回滚判断逻辑
**理由**：不同节点类型有不同规则，分离逻辑更清晰

### 决策 3：can_fallback 检查位置
**决策**：在确定需要回滚后，执行回滚前检查 can_fallback
**理由**：避免不必要的检查，只在需要回滚时检查

### 决策 4：自动流转排除机制
**决策**：在执行后自动流转逻辑中排除特定节点类型
**理由**：这些节点需要等待外部事件或用户操作，不应自动流转

## 考虑的替代方案

### 替代方案 1：统一回滚判断逻辑
**考虑**：使用统一的回滚判断逻辑，通过配置区分不同节点类型
**放弃原因**：不同节点类型规则差异较大，统一逻辑会变得复杂

### 替代方案 2：回滚操作由引擎内部实现
**考虑**：在引擎内部实现实际回滚操作
**放弃原因**：回滚操作涉及状态管理，应由外部系统统一处理

## 风险 / 权衡

### 风险 1：回滚判断逻辑复杂
**风险**：边界事件和中间捕获事件的回滚规则较复杂，容易出错
**缓解措施**：编写详细的单元测试，覆盖所有场景

### 风险 2：性能影响
**风险**：回滚判断可能影响执行性能
**缓解措施**：回滚判断逻辑简单，主要是节点 ID 比较，性能影响可忽略

### 风险 3：节点类型扩展
**风险**：未来可能需要支持更多节点类型
**缓解措施**：设计时考虑扩展性，使用策略模式或工厂模式

## 实现细节

### 回滚判断流程

```
ExecuteFromNode
  └─> CheckAndHandleRollback
       ├─> 判断 from_node 类型
       │    ├─> BoundaryEvent -> HandleBoundaryEventRollback
       │    ├─> IntermediateCatchEvent -> HandleIntermediateCatchEventRollback
       │    └─> Other -> HandleOtherNodeRollback
       └─> 如果需要回滚
            └─> 检查 can_fallback
                 └─> 执行回滚（由外部系统处理）
```

### 自动流转流程

```
ExecuteFromNode
  └─> 执行节点
       └─> advanceToNextNode
            └─> 检查节点类型
                 ├─> UserTask -> 不自动流转
                 ├─> IntermediateCatchEvent -> 不自动流转
                 ├─> EventBasedGateway -> 不自动流转
                 └─> Other -> 自动流转到下一个节点
```

## 未决问题

- [ ] 回滚操作的具体实现方式（由外部系统还是引擎内部）
- [ ] can_fallback 字段的默认值（默认允许还是禁止）
- [ ] 跳步骤异常的错误码定义


