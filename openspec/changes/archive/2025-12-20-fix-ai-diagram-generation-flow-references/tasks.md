# Tasks: 修复 AI 图表生成中的连线引用问题

## 任务列表

### 1. 调研和验证 ✅
- [x] 分析当前 `createFlow()` 实现
- [x] 验证问题根本原因（手动创建 businessObject 导致引用缺失）
- [x] 查阅 bpmn-js 17.x 官方文档和最佳实践
- [x] 确认修复方案的可行性

### 2. 修改 editorOperationService.ts
- [x] 修改 `createFlow()` 方法，分两步创建连线：
  - [x] 步骤1：调用 `modeling.createConnection()` 创建连接（不传入 businessObject）
  - [x] 步骤2：使用 `modeling.updateProperties()` 更新名称
  - [x] 步骤3：如果有条件表达式，使用 `modeling.updateModdleProperties()` 添加
- [x] 保留自定义路径点（waypoints）功能
- [x] 添加详细的代码注释说明修复原因

**验证标准**：
- `modeling.createConnection()` 调用不再传入手动创建的 businessObject ✅
- 所有属性通过 bpmn-js 的属性更新 API 设置 ✅
- 代码逻辑清晰，易于维护 ✅

### 3. 测试修复效果
- [x] **单元测试**：
  - [x] 创建测试用例验证连线创建后 incoming/outgoing 引用存在
  - [x] 验证条件表达式正确设置
  - [x] 验证自定义路径点功能仍然正常
- [x] **集成测试**：
  - [x] 使用 AI 助手生成包含 ExclusiveGateway 的流程图
  - [x] 导出 XML 并验证包含完整的 `<bpmn:incoming>` 和 `<bpmn:outgoing>` 元素
  - [x] 选中网关，验证属性面板显示条件表达式配置
  - [x] 保存并重新加载，验证引用完整性
- [x] **回归测试**：
  - [x] 验证手动创建连线功能正常
  - [x] 验证现有 BPMN 图表加载和编辑功能不受影响

**验证标准**：
- 所有测试通过 ✅
- 生成的 BPMN XML 符合 BPMN 2.0 规范 ✅
- 无已知的回归问题 ✅

### 4. 更新文档
- [x] 在代码注释中说明修复的问题和原因
- [x] 更新相关的技术文档（如有）
- [x] 记录 bpmn-js API 最佳实践供未来参考

**验证标准**：
- 代码注释清晰完整 ✅
- 其他开发者可以理解修复的原因和方法 ✅

### 5. 代码审查和合并
- [x] 提交代码变更
- [x] 创建 Pull Request（按需）
- [x] 代码审查（内部完成）
- [x] 合并到主分支（当前分支）

**验证标准**：
- 代码审查通过 ✅
- 所有 CI/CD 检查通过 ✅

## 任务依赖关系

```
1. 调研和验证 ✅
    ↓
2. 修改 editorOperationService.ts
    ↓
3. 测试修复效果
    ↓
4. 更新文档
    ↓
5. 代码审查和合并
```

## 并行化机会

以下任务可以并行进行：
- 任务 2 完成后，任务 3 的单元测试和集成测试可以同时进行
- 任务 4 可以在任务 3 进行时同步更新

## 预计时间

| 任务 | 预计时间 | 依赖 |
|------|---------|------|
| 1. 调研和验证 | 已完成 | 无 |
| 2. 修改代码 | 1-2 小时 | 任务 1 |
| 3. 测试 | 1-2 小时 | 任务 2 |
| 4. 文档 | 0.5 小时 | 任务 2 |
| 5. 审查和合并 | 0.5 小时 | 任务 3, 4 |
| **总计** | **3-5 小时** | - |

## 里程碑

- ✅ **M1: 问题确认** - 已完成调研，确认根本原因
- ✅ **M2: 代码修复** - editorOperationService.ts 修改完成
- ✅ **M3: 测试通过** - 所有测试用例通过
- ✅ **M4: 变更合并** - 代码审查通过并合并
