# 设计文档：BPMN 解析器

## 上下文

需要实现一个 BPMN XML 解析器，将符合 BPMN 2.0 标准的 XML 文件解析为 Go 结构体 `WorkflowDefinition`，以便后续的业务逻辑处理。

## 目标 / 非目标

### 目标
- 解析标准的 BPMN 2.0 XML 格式
- 提取节点、序列流、消息等核心元素
- 构建图结构（邻接表）以支持图遍历算法
- 提供清晰的错误信息

### 非目标
- 解析 BPMN 图表布局信息（BPMNDiagram 部分）
- 解析扩展元素（extensionElements）的详细内容
- 验证 BPMN 语义正确性（如流程是否可执行）
- 支持 BPMN 1.x 格式

## 决策

### 决策：使用标准库 `encoding/xml`

**理由**：
- Go 标准库提供，无需额外依赖
- 性能良好，适合解析 XML
- 通过结构体标签可以方便地映射 XML 元素

**考虑的替代方案**：
- `github.com/beevik/etree`：更灵活的 XML 操作，但增加了外部依赖
- `github.com/lestrrat-go/libxml2`：功能强大但依赖 C 库，部署复杂

### 决策：解析器位置

**理由**：
- 创建独立的 `server/internal/parser/` 包
- 保持解析逻辑与业务逻辑分离
- 便于测试和复用

**考虑的替代方案**：
- 放在 `services` 包中：但解析器不是业务服务，而是工具函数
- 放在 `models` 包中：但解析逻辑不应该与数据模型混在一起

### 决策：函数签名

```go
func ParseBPMN(bpmnContent string) (*models.WorkflowDefinition, error)
```

**理由**：
- 简单直接，接受字符串输入
- 返回结构体指针和错误，符合 Go 惯例
- 不依赖外部状态，便于测试

## 风险 / 权衡

### 风险：BPMN XML 格式复杂性

**缓解措施**：
- 先实现核心元素（节点、序列流）的解析
- 对于可选元素（消息、变量声明）可以暂时跳过或返回空值
- 逐步扩展支持的元素类型

### 风险：命名空间处理

**缓解措施**：
- 使用 XML 命名空间前缀（`bpmn:`）进行解析
- 在解析时正确处理命名空间声明

### 权衡：性能 vs 灵活性

- 使用标准库 `encoding/xml` 性能好，但需要定义完整的结构体
- 如果未来需要更灵活的解析，可以考虑切换到 `etree`

## 迁移计划

不涉及迁移，这是新功能。

## 未决问题

- 是否需要支持子流程（subProcess）的递归解析？
- 变量声明（VariableDeclaration）的解析优先级如何？
- 是否需要验证解析后的图结构（如检查孤立节点）？

