# 变更：添加证券业务示例应用（biz-sample）

## 为什么

为了演示和测试 BPMN 工作流在实际业务场景中的应用，需要创建一个完整的业务示例应用。该应用模拟证券手机 App 的核心业务流程，包括用户注册、开户、入金和交易等场景。这将：

1. **业务场景验证**：提供真实业务场景来验证工作流引擎的功能
2. **集成测试**：作为工作流引擎与业务系统集成的测试平台
3. **演示和培训**：为团队提供可运行的业务示例，便于理解工作流在实际业务中的应用
4. **开发参考**：为其他业务系统集成提供参考实现

## 变更内容

### 1. 项目结构
- 在项目根目录下创建 `biz-sample/` 目录
- **变更**：未使用 Lerna，而是使用简单的 monorepo 结构
- 包含 `packages/client/`（React 18 + TypeScript + Vite）和 `packages/server/`（Node.js + TypeScript + Koa）两个子包
- 前端使用 `npm run dev` 启动开发服务器
- 后端使用 `npm run start` 启动服务（通过 nodemon + ts-node）

### 2. 后端服务（Node.js + TypeScript + Koa）
- **已实现的 API**：
  - `POST /api/auth/register`: 用户注册 API
  - `POST /api/account/open`: 开户 API
  - `POST /api/account/deposit`: 入金 API
  - `POST /api/trade/buy`: 买入交易 API
  - `POST /api/trade/sell`: 卖出交易 API
  - `GET /api/health`: 健康检查端点
- **实现特性**：
  - 统一的错误处理和响应格式
  - CORS 配置（允许 `client.biz.com` 域名，包括带端口的开发环境）
  - 使用内存存储（Map）管理用户、账户和交易数据
  - UUID 生成用户和交易 ID
- **配置部署域名**：生产环境 `server.biz.com`，开发环境监听 `0.0.0.0:4000`

### 3. 前端应用（React + TypeScript + shadcn/ui）
- **技术栈变更**：使用 React 18 + TypeScript 替代原计划的 Vue 3
- **UI 框架**：使用 shadcn/ui 组件库（基于 Radix UI + Tailwind CSS）
- **实现的页面**：
  - WelcomePage: 欢迎页面（登录/注册入口）
  - RegisterPage: 手机号注册页面（包含密码、确认密码、验证码功能）✅ 已集成后端 API
  - AccountOpeningPage: 开户页面（分步骤：基本信息+银行卡、身份认证、风险测评）✅ 已集成后端 API
  - MainApp: 主应用容器（底部导航栏）
  - HomePage: 首页（市场行情、热门股票、资讯）
  - TradePage: 交易页面（股票搜索、买入/卖出）✅ 已集成后端 API
  - AssetsPage: 资产页面（账户总览、持仓、交易记录、入金/取款）✅ 已集成入金 API
  - ProfilePage: 个人中心
- **API 集成**：✅ 已完成
  - 创建统一的 API 客户端服务（`services/api.ts`）
  - 集成用户注册 API（包含密码字段）
  - 集成开户 API（包含银行卡信息）
  - 集成交易 API（买入/卖出）
  - 集成入金 API
  - 统一的错误处理和加载状态
- **状态管理**：使用 React Hooks（useState）进行本地状态管理，结合后端 API 数据
- **UI 特性**：
  - 完整的响应式设计，适配移动端
  - 使用 shadcn/ui 提供的现代化 UI 组件
  - 实时股价更新模拟（3秒刷新）
  - 完整的表单验证和错误提示
  - 使用 sonner 进行 toast 提示
  - 密码输入带显示/隐藏切换
  - 银行选择下拉菜单
  - 加载状态指示器
- **路由导航**：未使用 React Router，而是通过组件状态切换实现页面导航
- **配置部署域名**：生产环境 `client.biz.com`，开发环境 `client.biz.com:8080`

### 4. 业务场景
- **注册**：用户填写手机号、验证码、密码等信息完成注册
- **开户**：用户提交身份信息、银行卡信息等完成证券账户开户
- **入金**：用户从银行卡转入资金到证券账户
- **交易**：用户进行股票买卖交易操作

## 影响

- **受影响的规范**：
  - 新增 `biz-sample` 规范能力
- **受影响的代码**：
  - 新增 `biz-sample/` 目录及其所有内容
  - 不影响现有代码结构
- **数据影响**：
  - 使用内存存储（Map）管理数据，重启后数据丢失
  - 不影响现有数据
- **用户影响**：
  - 提供完整的前后端集成业务示例应用
  - 核心业务流程（注册、开户、入金、交易）可端到端运行
  - ✅ 前端已集成后端 API，可进行真实的业务操作
  - 可作为工作流引擎的业务接口集成参考架构

## 前后端集成状态

### 当前状态
- ✅ 后端：已实现完整的 RESTful API（注册、开户、入金、交易）
- ✅ 前端：已实现完整的 UI 界面和交互逻辑
- ✅ **已集成**：前端已集成后端 API，核心业务流程可端到端运行

### 已完成的集成工作
1. ✅ **创建 API 客户端**：
   - 实现统一的 HTTP 客户端（`services/api.ts`）
   - 配置生产/开发环境的后端服务地址
   - 实现请求拦截器（支持 token 认证）
   - 统一错误处理

2. ✅ **用户注册流程**：
   - 前端添加密码和确认密码字段
   - 集成注册 API，传递 phone、password、verifyCode
   - 返回 userId 并保存到用户状态

3. ✅ **开户流程**：
   - 前端添加银行卡号和开户银行字段
   - 集成开户 API，传递 userId、realName、idCard、bankCard、bankName
   - 返回 accountId 并保存到用户状态

4. ✅ **交易功能**：
   - 集成买入/卖出 API
   - 从后端获取实时余额并更新本地状态
   - 显示交易结果和错误处理

5. ✅ **入金功能**：
   - 集成入金 API，传递 accountId、amount、bankCard
   - 实时更新账户余额

### 待完成的集成工作
1. ⚠️ **用户认证和会话管理**：
   - 目前注册后自动创建本地用户对象
   - 需要实现真实的登录功能
   - 需要存储和管理 token

2. ⚠️ **持仓和交易记录**：
   - 当前持仓数据仍为硬编码
   - 交易记录仍为硬编码
   - 需要后端提供查询接口

3. ⚠️ **提现功能**：
   - 前端已有 UI，但未调用后端 API
   - 后端未实现提现接口

详细的不对齐分析和集成计划见：`frontend-backend-alignment.md`

