# 代码质量保障体系技术设计

## 上下文

根据 `docs/TESTING_AND_VALIDATION_STRATEGY.md` 文档，需要建立三层代码质量保障体系：
1. **AI预设提示词层面**：强制AI遵循TDD和验证流程
2. **测试架构层面**：完善前端、后端、E2E测试基础设施
3. **CI/CD层面**：自动化测试和持续集成

这是一个跨领域的架构性变更，涉及开发流程、测试工具、CI/CD配置等多个方面。

## 目标 / 非目标

### 目标
- 确保AI修改代码后立即发现并修复问题
- 建立完整的测试金字塔（单元测试、集成测试、E2E测试）
- 实现自动化验证流程，减少人工检查
- 提供清晰的测试报告和趋势分析
- 遵循TDD开发范式，提升代码质量

### 非目标
- 不实现复杂的性能测试框架（基础性能测试即可）
- 不实现完整的代码审查自动化（聚焦测试验证）
- 不实现复杂的测试数据生成工具（手动准备即可）
- 不实现分布式测试执行（单机执行即可）

## 决策

### 决策 1: 测试框架选择

**前端测试框架**：
- **单元测试**：继续使用 Jest + @vue/test-utils（已存在）
- **E2E测试**：使用 Playwright（现代化、功能强大）

**后端测试框架**：
- **单元测试**：继续使用 Go 标准 testing 包（已存在）
- **集成测试**：继续使用 Go testing with tags（已存在）

**理由**：
- 复用现有测试框架，降低学习成本
- Playwright 是业界标准的E2E测试工具，功能完善
- Go 标准 testing 包足够强大，无需额外框架

**考虑的替代方案**：
- Cypress：功能类似，但 Playwright 更现代，支持多浏览器
- Testify：Go 测试库，但标准包已足够

### 决策 2: TDD工作流集成

**选择**：在 `openspec/AGENTS.md` 中添加强制验证要求，要求AI遵循TDD流程。

**理由**：
- OpenSpec 是项目的规范管理工具，AGENTS.md 是AI的工作指南
- 通过预设提示词强制要求，确保AI遵循流程
- 不需要额外的工具或配置

**考虑的替代方案**：
- 使用 `.cursorrules`：功能类似，但 OpenSpec 更符合项目规范
- 使用 Git hooks：只能约束提交，不能约束AI的实时行为

### 决策 3: 验证脚本架构

**选择**：使用 Shell 脚本实现验证逻辑，提供统一的验证入口。

**理由**：
- Shell 脚本简单直接，易于维护
- 可以跨平台（Linux/macOS）
- 可以集成到 CI/CD 中
- 不需要额外的运行时依赖

**考虑的替代方案**：
- Node.js 脚本：需要 Node.js 环境，增加依赖
- Python 脚本：需要 Python 环境，增加依赖
- Makefile：功能有限，不适合复杂逻辑

### 决策 4: CI/CD平台选择（暂不实施）

**选择**：CI/CD集成将在后续阶段实施，当前阶段专注于本地验证脚本。

**理由**：
- 先建立本地验证基础设施，确保测试框架完善
- 本地验证脚本可以复用，后续集成到CI/CD更容易
- 降低初期实施复杂度

**未来考虑**：
- GitHub Actions 或 GitLab CI
- 配置文件简单，易于维护

### 决策 5: 测试执行策略

**选择**：分层测试策略
- **快速测试**：每次代码修改后运行（< 2分钟）
- **完整测试**：提交前运行（< 10分钟）
- **完整测试套件**：CI/CD中运行（< 30分钟）

**理由**：
- 快速反馈，提升开发效率
- 避免测试执行时间过长影响开发
- 分层执行，平衡速度和完整性

**考虑的替代方案**：
- 每次都运行完整测试：执行时间过长，影响开发效率
- 仅在CI/CD中运行：反馈延迟，问题发现不及时

### 决策 6: 测试覆盖率目标

**选择**：
- 单元测试覆盖率：> 70%
- 关键业务逻辑：> 90%

**理由**：
- 70% 是业界常见的覆盖率目标
- 关键业务逻辑需要更高覆盖率
- 平衡测试成本和覆盖率

**考虑的替代方案**：
- 100% 覆盖率：成本过高，收益递减
- 50% 覆盖率：覆盖率不足，风险较高

### 决策 7: Headless Browser验证

**选择**：使用 Playwright 进行 headless browser 验证，验证应用可以正常启动和运行。

**理由**：
- 可以验证应用在真实浏览器环境中的行为
- 可以发现运行时错误（JavaScript错误、渲染问题等）
- Playwright 支持 headless 模式，适合CI/CD

**考虑的替代方案**：
- 仅使用单元测试：无法发现运行时问题
- 使用 Puppeteer：功能类似，但 Playwright 更现代

## 风险 / 权衡

### 风险 1: 测试执行时间过长
- **风险**：影响开发效率
- **缓解**：分层测试，快速测试优先，完整测试在本地验证脚本中运行

### 风险 2: 测试维护成本高
- **风险**：测试代码难以维护
- **缓解**：测试代码规范，定期重构，使用清晰的测试命名

### 风险 3: 测试环境不稳定
- **风险**：测试结果不可靠
- **缓解**：测试环境隔离，数据清理机制，使用容器化（可选）

### 风险 4: AI验证要求过于严格
- **风险**：AI无法完成简单修改
- **缓解**：分层验证，简单修改只需基础验证，复杂修改才需要完整验证

## 迁移计划

### Phase 1: AI预设提示词更新（立即实施）
- 更新 `openspec/AGENTS.md`
- 创建验证脚本模板

### Phase 2: 前端测试增强（1-2天）
- 添加 Playwright 配置
- 实现 Headless Browser 验证
- 实现服务启动验证脚本

### Phase 3: 后端测试增强（1-2天）
- 实现服务启动验证脚本
- 更新 Makefile
- 增强单元测试覆盖率

### Phase 4: E2E测试完善（3-5天）
- 完善 Playwright 配置
- 实现核心功能 E2E 测试
- 实现回归测试套件

### Phase 5: CI/CD集成（暂不实施）
- CI/CD集成将在后续阶段实施
- 当前阶段专注于本地验证脚本和测试基础设施

## 未决问题

- [ ] 是否使用 Docker 进行测试环境隔离？
- [ ] 是否实现代码覆盖率报告的本地展示？
- [ ] CI/CD集成将在何时实施？（后续阶段）

