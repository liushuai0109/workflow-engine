# 设计文档：证券业务示例应用（biz-sample）

## 上下文

需要创建一个独立的业务示例应用，模拟证券手机 App 的核心业务流程。该应用将作为 BPMN 工作流引擎的业务接口集成示例，展示如何在实际业务场景中使用工作流。

## 目标 / 非目标

### 目标
- 提供完整的业务示例，包括前端页面和后台接口
- 模拟真实的证券业务场景（注册、开户、入金、交易）
- 使用现代技术栈（Vue 3、TypeScript、Node.js、Koa）
- 代码结构清晰，易于理解和扩展
- 可作为工作流引擎的业务接口集成参考

### 非目标
- 不实现完整的证券交易系统（仅示例）
- 不实现复杂的业务逻辑（简化处理）
- 不实现真实的支付和交易接口（模拟数据）
- 不实现用户认证和授权（简化处理）
- 不实现数据库持久化（可使用内存存储或简单文件存储）

## 决策

### 1. 技术栈选择

**决策**：使用 Node.js + TypeScript + Koa 作为后端，Vue 3 + TypeScript 作为前端

**理由**：
- Node.js 生态系统成熟，与前端技术栈一致
- TypeScript 提供类型安全，减少错误
- Koa 轻量级，中间件机制灵活
- Vue 3 Composition API 现代化，适合移动端开发

**考虑的替代方案**：
- Go + Gin：与现有 server 目录技术栈一致，但需要学习成本
- Express：更成熟但更重量级，Koa 更简洁
- React：Vue 3 更适合快速开发，学习曲线更平缓

### 2. 项目结构

**决策**：使用 Lerna 管理 monorepo 结构

**理由**：
- 统一管理多个包的依赖和版本
- 便于包之间的代码共享和复用
- 统一的构建和发布流程
- 与现有的 `client/` 和 `server/` 目录分离，避免混淆
- 清晰的职责划分

**目录结构**：
```
biz-sample/
├── packages/
│   ├── client/          # Vue 3 前端应用
│   │   ├── src/
│   │   │   ├── pages/   # 页面组件
│   │   │   ├── services/ # API 服务
│   │   │   ├── router/  # 路由配置
│   │   │   └── ...
│   │   ├── package.json
│   │   └── ...
│   └── server/          # Node.js + Koa 后端
│       ├── src/
│       │   ├── routes/  # 路由定义
│       │   ├── controllers/ # 控制器
│       │   ├── services/ # 业务逻辑
│       │   └── ...
│       ├── package.json
│       └── ...
├── lerna.json           # Lerna 配置
├── package.json         # 根 package.json
└── README.md            # 使用说明
```

**脚本命令**：
- 使用 `npm run start` 启动服务（替代 `npm run dev`）
- 通过 Lerna 统一管理各包的启动脚本

### 3. 数据存储

**决策**：使用内存存储（Map/对象）或简单的 JSON 文件存储

**理由**：
- 示例应用，不需要复杂的数据库
- 简化部署和运行
- 便于快速开发和测试

**考虑的替代方案**：
- PostgreSQL：与现有 server 一致，但增加复杂度
- SQLite：轻量级，但需要数据库文件管理

### 4. API 设计

**决策**：RESTful API 设计，统一的响应格式

**理由**：
- 符合 REST 规范，易于理解
- 统一的响应格式便于前端处理
- 支持 JSON 格式，易于集成

**API 路径设计**：
- `POST /api/auth/register` - 用户注册
- `POST /api/account/open` - 开户
- `POST /api/account/deposit` - 入金
- `POST /api/trade/buy` - 买入
- `POST /api/trade/sell` - 卖出
- `GET /api/health` - 健康检查

**API 基础地址**：
- 生产环境：`https://server.biz.com`
- 开发环境：`http://localhost:4000`（可配置）

### 5. 前端路由设计

**决策**：使用 Vue Router，单页应用（SPA）

**理由**：
- 现代化的前端应用架构
- 支持路由导航和参数传递
- 适合移动端应用场景

**路由设计**：
- `/` - 首页/登录页
- `/register` - 注册页
- `/account/open` - 开户页
- `/account/deposit` - 入金页
- `/trade` - 交易页

### 6. 域名配置

**决策**：生产和开发环境使用相同的域名，开发环境通过端口区分

**理由**：
- 前后端分离部署，便于独立扩展
- 符合微服务架构模式
- 生产和开发环境使用相同域名，便于配置管理和测试
- 开发环境通过端口区分，避免域名解析配置

**域名配置**：
- **生产环境**：
  - 前端服务：`client.biz.com`（默认端口 80/443）
  - 后端服务：`server.biz.com`（默认端口 80/443）
- **开发环境**：
  - 前端服务：`client.biz.com:8080`
  - 后端服务：`server.biz.com:4000`（可配置）

**CORS 配置**：
- 后端应配置允许 `client.biz.com` 域名的跨域请求（包括带端口的开发环境）
- 前端 API 客户端应配置后端服务地址：
  - 生产环境：`https://server.biz.com`
  - 开发环境：`http://server.biz.com:4000`

## 风险 / 权衡

### 风险
1. **技术栈不一致**：与现有 Go 后端不一致，可能增加维护成本
   - **缓解**：作为独立示例应用，不影响主项目
2. **数据持久化**：内存存储重启后数据丢失
   - **缓解**：示例应用，数据丢失可接受，或使用文件存储
3. **安全性**：缺少认证和授权机制
   - **缓解**：示例应用，不处理真实数据

### 权衡
- **简单 vs 完整**：选择简单实现，便于理解和扩展
- **独立 vs 集成**：选择独立应用，避免影响现有系统

## 迁移计划

无需迁移，这是全新的功能模块。

## 未决问题

- [ ] 是否需要实现用户登录和会话管理？
- [ ] 是否需要实现数据持久化（文件存储）？
- [ ] 是否需要与现有的 Go 后端集成？

